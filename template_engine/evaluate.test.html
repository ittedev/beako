<!DOCTYPE html>
<meta charset="UTF-8">
<title>virtual_dom/load.test.js</title>
<link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
<div id="mocha"></div>
<script src="https://unpkg.com/chai/chai.js"></script>
<script>
var i = 0
var equal = (v, p) => {
  try {
    chai.expect(JSON.parse(JSON.stringify(v))).deep.equal(p)
  } catch (e) {
    setTimeout(() => document.querySelectorAll('pre.error')[i++].innerHTML += '\n\n' + Diff.diffJson(v, p).map(p => `<span style="color: ${p.added ? 'red' : p.removed ? 'green' : '#000'}">${p.value}</span>`).join(''), 100)
    throw e
  }
}
</script>
<script src="https://unpkg.com/mocha/mocha.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
<script type="module">
import { parse } from './parse.js'
import { evaluate } from './evaluate.js'

mocha.setup('bdd')

describe('evaluate(): text', function() {
  it('evaluate Text Node', () => {
    const tree = evaluate(parse('Hello beako!'), [])
    equal(tree, {
      children: [
        "Hello beako!"
      ]
    })
  })

  it('evaluate unicode', () => {
    const tree = evaluate(parse('مرحبا ベア子😆'), [])
    equal(tree, {
      children: [
        "مرحبا ベア子😆"
      ]
    })
  })

  it('evaluate a variable in Text Node', () => {
    const tree = evaluate(parse('Hello {{ name }}!'), [{ name: 'beako' }])
    equal(tree, {
      children: [
        "Hello beako!"
      ]
    })
  })

  it('evaluate Text Node in element', () => {
    const tree = evaluate(parse('<p>Hello beako!</p>'))
    equal(tree, {
      children: [
        {
          tag: "p",
          children: [
            "Hello beako!"
          ]
        }
      ]
    })
  })
  it('evaluate a element in Text Node', () => {
    const tree = evaluate(parse('Hello <span>beako</span>!'))
    equal(tree, {
      children: [
        "Hello ",
        {
          tag: "span",
          children: [
            "beako"
          ]
        },
        "!"
      ]
    })
  })
})

describe('evaluate(): style', function() {
  it('evaluate: style', () => {
    const tree = evaluate(parse('<p style="color: red"></p>'))
    equal(tree, {
      children: [
        {
          tag: "p",
          style: "color: red"
        }
      ]
    })
  })

  it('evaluate: add style only', () => {
    const tree = evaluate(parse(`<p style+="'color: red'"></p>`))
    equal(tree, {
      children: [
        {
          tag: "p",
          style: "color: red"
        }
      ]
    })
  })

  it('evaluate: add style', () => {
    const tree = evaluate(parse(`<p style="color: red" style+="\`margin-top: \${x}px\`"></p>`), [{ x: 10 }])
    equal(tree, {
      children: [
        {
          tag: "p",
          style: "color: red;margin-top: 10px"
        }
      ]
    })
  })

  it('evaluate: add styles', () => {
    const tree = evaluate(parse(`<p style="color: red" style+1="'margin-top: 5px'" style+2="'margin: 0 auto'"></p>`))
    equal(tree, {
      children: [
        {
          tag: "p",
          style: "color: red;margin-top: 5px;margin: 0 auto"
        }
      ]
    })
  })
})

describe('evaluate(): attr', function() {
  it('evaluate: attr', () => {
    const tree = evaluate(parse('<p id="beako"></p>'))
    equal(tree, {
      children: [
        {
          tag: "p",
          attr: {
            id: "beako"
          }
        }
      ]
    })
  })

  it('evaluate: add attr variable', () => {
    const tree = evaluate(parse(`<p id:="id"></p>`), [{ id: 'beako' }])
    equal(tree, {
      children: [
        {
          tag: "p",
          attr: {
            id: "beako"
          }
        }
      ]
    })
  })

  it('evaluate: multi attr is not string', () => {
    const tree = evaluate(parse('<p value:="value"></p>'), [{ value: 10 }])
    equal(tree, {
      children: [
        {
          tag: "p",
          attr: {
            value: 10
          }
        }
      ]
    })
  })

  it('evaluate: multi attr', () => {
    const tree = evaluate(parse('<p id:="id" slot="my-slot" value:="value"></p>'), [{ id: 'beako', value: 10 }])
    equal(tree, {
      children: [
        {
          tag: "p",
          attr: {
            id: "beako",
            slot: "my-slot",
            value: 10
          }
        }
      ]
    })
  })
})

mocha.run()
</script>
